<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#1a3a5f">
<meta name="robots" content="noindex,nofollow">
<title>CRA Review | Victorian Projects</title>
<link rel="icon" href="images/favicon.svg" type="image/svg+xml">
<link rel="apple-touch-icon" href="images/favicon.svg">
<link rel="alternate icon" href="images/victorian-projects-logo.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&family=Libre+Baskerville:ital,wght@0,400;0,700&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#f0f7ff;
  --text:#1a2d4a;--text2:#3d5a80;--text3:#5c7a9e;
  --navy:#1a3a5f;--blue:#2563eb;--blue-light:#48c9f5;--blue-dim:rgba(72,201,245,.12);
  --grey:#4a5568;--grey-light:#718096;
  --glass:rgba(255,255,255,.75);--glass-border:rgba(255,255,255,.5);
  --glass-dark:rgba(26,58,95,.04);
  --green:#059669;--green-dim:rgba(5,150,105,.1);--green-border:rgba(5,150,105,.25);
  --amber:#d97706;--amber-dim:rgba(217,119,6,.1);--amber-border:rgba(217,119,6,.25);
  --red:#dc2626;--red-dim:rgba(220,38,38,.1);--red-border:rgba(220,38,38,.25);
  --font:'DM Sans',system-ui,sans-serif;--font-serif:'Libre Baskerville',serif;
  --radius:16px;--radius-sm:12px;
  --shadow:0 2px 8px rgba(26,58,95,.06);
  --shadow-glass:0 8px 32px rgba(26,58,95,.08);
}
html{scroll-behavior:smooth}
body{font-family:var(--font);background:linear-gradient(160deg,#f0f7ff 0%,#e8f4fc 40%,#f5f9ff 100%);background-attachment:fixed;color:var(--text);-webkit-font-smoothing:antialiased;min-height:100vh;padding-bottom:80px;font-size:15px;line-height:1.6}

/* ‚ïê‚ïê‚ïê TOP BAR - Glass morphism ‚ïê‚ïê‚ïê */
.topbar{background:var(--glass);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-bottom:1px solid var(--glass-border);padding:12px 20px;position:sticky;top:0;z-index:100;box-shadow:var(--shadow)}
.topbar-inner{max-width:900px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:12px}
.topbar-logo{display:flex;align-items:center;gap:10px;text-decoration:none;color:inherit}
.topbar-logo img{height:40px;width:auto}
.topbar-nav{display:flex;gap:8px}
.topbar-nav a{padding:10px 16px;font-size:14px;font-weight:600;color:var(--text2);text-decoration:none;border-radius:var(--radius-sm);transition:all .2s}
.topbar-nav a:hover{color:var(--navy);background:var(--blue-dim)}
.topbar-nav a.active{color:var(--navy);background:var(--blue-dim)}
@media(max-width:480px){.topbar{padding:10px 14px}.topbar-logo img{height:32px}.topbar-nav a{padding:8px 12px;font-size:13px}}

/* ‚ïê‚ïê‚ïê REMINDER BANNER - Waiting for you ‚ïê‚ïê‚ïê */
.reminder-banner{display:none;background:linear-gradient(90deg,var(--amber),#ea580c);color:#fff;padding:12px 20px;font-size:14px;font-weight:600;text-align:center;box-shadow:0 2px 12px rgba(217,119,6,.3);position:sticky;top:65px;z-index:99}
.reminder-banner a{color:#fff;text-decoration:underline;margin-left:6px}
.reminder-banner a:hover{text-decoration:none}
.reminder-banner.visible{display:block}

/* ‚ïê‚ïê‚ïê MAIN ‚ïê‚ïê‚ïê */
.main{max-width:900px;margin:0 auto;padding:16px 20px;padding-bottom:100px}
@media(max-width:480px){.main{padding:12px 14px}}

/* ‚ïê‚ïê‚ïê ATTENTION HERO - Glass morphism ‚ïê‚ïê‚ïê */
.attention-hero{background:linear-gradient(135deg,rgba(26,58,95,.9) 0%,rgba(37,99,235,.9) 100%);backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,.2);border-radius:var(--radius);padding:32px;color:#fff;margin-bottom:24px;box-shadow:var(--shadow-glass)}
.attention-hero h2{font-size:22px;font-weight:700;margin-bottom:8px;letter-spacing:-.3px}
.attention-hero p{font-size:15px;opacity:.95;line-height:1.6}
.attention-count{display:inline-block;background:rgba(255,255,255,.2);padding:8px 16px;border-radius:var(--radius-sm);font-weight:700;font-size:16px;margin-top:14px}

/* ‚ïê‚ïê‚ïê JOB CARDS - Glass morphism ‚ïê‚ïê‚ïê */
.jobs-list{display:flex;flex-direction:column;gap:14px}
.job-card{background:var(--glass);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);border:1px solid var(--glass-border);border-radius:var(--radius);padding:24px;cursor:pointer;transition:all .25s;box-shadow:var(--shadow)}
.job-card:hover{border-color:rgba(72,201,245,.4);box-shadow:var(--shadow-glass);transform:translateY(-2px)}
.job-card-header{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;margin-bottom:12px}
.job-card-name{font-size:17px;font-weight:700;color:var(--text);letter-spacing:-.3px;line-height:1.3}
.job-card-status{padding:6px 12px;border-radius:8px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px}
.status-active{background:var(--green-dim);color:var(--green)}
.status-review{background:var(--amber-dim);color:var(--amber)}
.status-complete{background:var(--blue-dim);color:var(--navy)}
.job-card-meta{display:flex;flex-wrap:wrap;gap:12px 24px;font-size:14px;color:var(--text2);margin-bottom:14px}
.job-card-meta span{display:flex;align-items:center;gap:6px}
.job-card-progress{margin-top:14px}
.progress-bar{height:8px;background:rgba(255,255,255,.6);border-radius:4px;overflow:hidden}
.progress-fill{height:100%;border-radius:4px;transition:width .5s ease}
.progress-fill.green{background:linear-gradient(90deg,#059669,#10b981)}
.progress-fill.blue{background:linear-gradient(90deg,#2563eb,#48c9f5)}
.progress-fill.amber{background:linear-gradient(90deg,#d97706,#f59e0b)}
.progress-fill.red{background:linear-gradient(90deg,#dc2626,#ef4444)}
.progress-text{display:flex;justify-content:space-between;font-size:12px;color:var(--text3);margin-top:6px}

/* ‚ïê‚ïê‚ïê CONTRACT HEADER - Glass ‚ïê‚ïê‚ïê */
.contract-header{background:var(--glass);backdrop-filter:blur(16px);border:1px solid var(--glass-border);border-radius:var(--radius);padding:28px;margin-bottom:24px;box-shadow:var(--shadow)}
.contract-header h1{font-size:24px;font-weight:800;color:var(--navy);margin-bottom:6px;letter-spacing:-.5px;font-family:var(--font-serif)}
.contract-header .sub{font-size:15px;color:var(--text2);margin-bottom:20px;line-height:1.5}
.contract-meta{display:grid;grid-template-columns:1fr;gap:14px}
@media(min-width:400px){.contract-meta{grid-template-columns:repeat(2,1fr)}}
@media(min-width:600px){.contract-meta{grid-template-columns:repeat(4,1fr)}}
.meta-box{background:rgba(255,255,255,.6);backdrop-filter:blur(8px);border:1px solid var(--glass-border);border-radius:var(--radius-sm);padding:16px;text-align:center}
.meta-box-label{font-size:10px;text-transform:uppercase;letter-spacing:1.2px;color:var(--text3);margin-bottom:6px;font-weight:600}
.meta-box-value{font-size:16px;font-weight:700;color:var(--navy);word-break:break-word}
@media(max-width:400px){.meta-box-value{font-size:14px}}

/* ‚ïê‚ïê‚ïê PROJECT LOGO ‚ïê‚ïê‚ïê */
.project-logo-wrap{margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid var(--glass-border)}
.project-logo{display:block;max-height:80px;width:auto;object-fit:contain}
@media(max-width:500px){.project-logo{max-height:60px}}

/* ‚ïê‚ïê‚ïê ROLE TABS - Glass, responsive stack ‚ïê‚ïê‚ïê */
.role-tabs{display:flex;flex-wrap:wrap;gap:6px;background:rgba(255,255,255,.5);backdrop-filter:blur(8px);padding:6px;border-radius:var(--radius);margin-bottom:24px;border:1px solid var(--glass-border)}
.role-tab{padding:12px 14px;font-size:13px;font-weight:600;border-radius:var(--radius-sm);cursor:pointer;transition:all .2s;color:var(--text2);white-space:nowrap;flex:1;min-width:120px;text-align:center}
@media(max-width:520px){.role-tabs{flex-direction:column;}.role-tab{min-width:100%;flex:none;padding:14px 16px}}
@media(min-width:521px){.role-tab{min-width:140px;padding:14px 18px;font-size:14px}}
.role-tab:hover{color:var(--navy)}
.role-tab.active{background:var(--glass);color:var(--navy);box-shadow:var(--shadow);border:1px solid var(--glass-border)}

/* ‚ïê‚ïê‚ïê CHECKLIST ITEMS - Glass, better readability ‚ïê‚ïê‚ïê */
.checklist-section{margin-bottom:28px}
.checklist-section-title{font-size:12px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:14px;padding-bottom:10px;border-bottom:1px solid var(--glass-border)}
.checklist-items{display:flex;flex-direction:column;gap:6px}
.cli{display:flex;align-items:flex-start;gap:16px;padding:18px 20px;background:var(--glass);backdrop-filter:blur(12px);border:1px solid var(--glass-border);border-radius:var(--radius-sm);cursor:pointer;transition:all .2s}
.cli:hover{background:rgba(255,255,255,.9);border-color:rgba(72,201,245,.3)}
.cli.done{background:var(--green-dim);border-color:var(--green-border)}
.cli-num{font-size:13px;font-weight:700;color:var(--text3);min-width:28px;padding-top:2px}
.cli.done .cli-num{color:var(--green)}
.cli-check{width:32px;height:32px;border:3px solid var(--text3);border-radius:10px;flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:all .2s;box-shadow:0 1px 4px rgba(26,58,95,.08)}
.cli:hover .cli-check,.cli:focus-within .cli-check{border-color:var(--navy);box-shadow:0 2px 8px rgba(26,58,95,.12)}
.cli.done .cli-check{background:var(--green);border-color:var(--green);border-width:3px;box-shadow:0 2px 8px rgba(5,150,105,.25)}
.cli.done .cli-check::after{content:'‚úì';color:#fff;font-size:18px;font-weight:700}
.cli-text{font-size:15px;line-height:1.6;color:var(--text);flex:1}
.cli.done .cli-text{color:var(--text2)}
.cli.highlight{animation:itemHighlight 2s ease-out}
@keyframes itemHighlight{0%{background:var(--amber-dim);border-color:var(--amber-border);box-shadow:0 0 0 4px rgba(217,119,6,.3)}50%{background:var(--amber-dim);border-color:var(--amber-border)}100%{background:var(--glass);border-color:var(--glass-border);box-shadow:none}}

/* ‚ïê‚ïê‚ïê SIGN-OFF BLOCK - Glass ‚ïê‚ïê‚ïê */
.signoff-block{background:var(--glass);backdrop-filter:blur(16px);border:2px solid rgba(72,201,245,.3);border-radius:var(--radius);padding:28px;margin-top:36px;box-shadow:var(--shadow)}
.signoff-block h3{font-size:17px;font-weight:700;margin-bottom:8px;color:var(--navy)}
.signoff-block p{margin-bottom:20px}
.signoff-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
@media(max-width:500px){.signoff-grid{grid-template-columns:1fr}}
.signoff-item{padding:18px;background:rgba(255,255,255,.6);backdrop-filter:blur(8px);border:1px solid var(--glass-border);border-radius:var(--radius-sm)}
.signoff-item.done{background:var(--green-dim);border-color:var(--green-border)}
.signoff-role{font-size:11px;text-transform:uppercase;letter-spacing:1.2px;color:var(--text3);margin-bottom:6px;font-weight:600}
.signoff-name{font-size:15px;font-weight:600;color:var(--navy)}
.signoff-date{font-size:13px;color:var(--text3);margin-top:6px}

/* ‚ïê‚ïê‚ïê FAB ‚ïê‚ïê‚ïê */
.fab{position:fixed;bottom:24px;right:24px;width:56px;height:56px;background:linear-gradient(135deg,var(--navy),var(--blue));color:#fff;border:none;border-radius:50%;font-size:24px;cursor:pointer;box-shadow:0 6px 24px rgba(26,58,95,.35);transition:all .2s;display:flex;align-items:center;justify-content:center;z-index:50}
.fab:hover{transform:scale(1.08);box-shadow:0 8px 32px rgba(26,58,95,.4)}

/* ‚ïê‚ïê‚ïê BREADCRUMB ‚ïê‚ïê‚ïê */
.breadcrumb{display:flex;align-items:center;gap:8px;font-size:13px;margin-bottom:20px;flex-wrap:wrap}
.breadcrumb a{color:var(--text2);text-decoration:none}
.breadcrumb a:hover{color:var(--blue)}
.breadcrumb span{color:var(--text3)}
.bc-sep{font-size:10px}

/* ‚ïê‚ïê‚ïê EMPTY STATE ‚ïê‚ïê‚ïê */
.empty-state{text-align:center;padding:80px 24px;color:var(--text3)}
.empty-state-icon{font-size:56px;margin-bottom:20px;opacity:.6}
.empty-state h3{font-size:20px;font-weight:600;color:var(--navy);margin-bottom:10px}
.empty-state p{font-size:15px;margin-bottom:24px;max-width:320px;margin-left:auto;margin-right:auto;line-height:1.6}
.btn-primary{display:inline-block;padding:12px 24px;background:linear-gradient(135deg,var(--navy),var(--blue));color:#fff;font-weight:600;font-size:14px;border-radius:var(--radius-sm);border:none;cursor:pointer;text-decoration:none;transition:all .2s}
.btn-primary:hover{opacity:.9;transform:translateY(-1px)}

/* ‚ïê‚ïê‚ïê BACK BUTTON ‚ïê‚ïê‚ïê */
.btn-back{display:inline-flex;align-items:center;gap:8px;padding:10px 0;font-size:15px;font-weight:600;color:var(--navy);background:none;border:none;cursor:pointer;margin-bottom:20px}
.btn-back:hover{color:var(--blue)}

/* ‚ïê‚ïê‚ïê NOTES MODAL ‚ïê‚ïê‚ïê */
.modal-overlay{position:fixed;inset:0;background:rgba(26,58,95,.4);backdrop-filter:blur(4px);z-index:200;display:none;align-items:center;justify-content:center;padding:20px}
.modal-overlay.visible{display:flex}
.modal{background:var(--glass);backdrop-filter:blur(20px);border:1px solid var(--glass-border);border-radius:var(--radius);padding:24px;max-width:420px;width:100%;box-shadow:var(--shadow-glass)}
.modal h3{font-size:17px;font-weight:700;color:var(--navy);margin-bottom:12px}
.modal textarea{width:100%;min-height:100px;padding:14px;border:1px solid var(--glass-border);border-radius:var(--radius-sm);font-family:var(--font);font-size:15px;resize:vertical;margin-bottom:16px}
.modal-actions{display:flex;gap:10px;justify-content:flex-end}
.cli-note-btn{flex-shrink:0;padding:8px 12px;font-size:13px;color:var(--text2);background:rgba(255,255,255,.8);border:1px solid var(--glass-border);border-radius:8px;cursor:pointer;transition:all .2s}
.cli-note-btn:hover{color:var(--navy);border-color:var(--blue);background:var(--blue-dim)}
.cli-note-btn.has-note{color:var(--blue);border-color:var(--blue);background:var(--blue-dim)}
.cli-row{display:flex;align-items:flex-start;gap:16px}
.cli-main{flex:1;min-width:0;display:flex;align-items:flex-start;gap:16px}

/* ‚ïê‚ïê‚ïê SIGNOFF MODAL - Canvas responsive ‚ïê‚ïê‚ïê */
.signoff-modal canvas{max-width:100%;height:auto}
@media(max-width:440px){.signoff-modal{max-width:96vw!important}#signoff-canvas{width:100%!important;max-width:100%!important}}
</style>
</head>
<body>

<div class="topbar">
  <div class="topbar-inner">
    <a href="index.html" class="topbar-logo">
      <img src="images/victorian-projects-logo.png" alt="Victorian Projects">
    </a>
    <nav class="topbar-nav">
      <a href="index.html" title="Back to Project Command Centre">Home</a>
      <a href="#" class="active" id="nav-dashboard">My Attention</a>
      <a href="#" id="nav-all">All CRAs</a>
    </nav>
  </div>
</div>
<div class="reminder-banner" id="reminder-banner">
  <span id="reminder-text"></span>
  <a href="#" id="reminder-link">View My Attention ‚Üí</a>
</div>

<div class="main">

  <!-- DASHBOARD: Needs Attention -->
  <div id="view-dashboard">
    <div class="attention-hero" id="attention-hero">
      <h2>What needs your attention</h2>
      <p id="attention-desc">Items awaiting your sign-off or overdue.</p>
      <span class="attention-count" id="attention-count">0 items</span>
    </div>
    <div id="attention-list" class="jobs-list"></div>
    <div id="attention-empty" class="empty-state" style="display:none">
      <div class="empty-state-icon">‚úì</div>
      <h3>All caught up</h3>
      <p>No items need your attention right now.</p>
    </div>
  </div>

  <!-- ALL CRAs LIST -->
  <div id="view-all" style="display:none">
    <h2 style="font-size:20px;font-weight:700;margin-bottom:20px">All CRA Reviews</h2>
    <div id="all-list" class="jobs-list"></div>
  </div>

  <!-- CRA DETAIL -->
  <div id="view-detail" style="display:none">
    <button class="btn-back" onclick="showView('dashboard')">‚Üê Back</button>
    <div class="contract-header" id="contract-header"></div>
    <div class="role-tabs" id="role-tabs"></div>
    <div id="checklist-content"></div>
    <div class="signoff-block" id="signoff-block"></div>
  </div>

</div>

<button class="fab" id="fab" onclick="newCRA()" title="New CRA" style="display:none">+</button>

<div class="modal-overlay" id="notes-modal" onclick="if(event.target===this)closeNotesModal()">
  <div class="modal" onclick="event.stopPropagation()">
    <h3 id="notes-modal-title">Note for item <span id="notes-modal-num"></span></h3>
    <textarea id="notes-modal-text" placeholder="Add a note for this checklist item..."></textarea>
    <div class="modal-actions">
      <button class="btn-primary" style="padding:8px 16px;font-size:13px" onclick="saveNote()">Save</button>
      <button class="cli-note-btn" onclick="closeNotesModal()">Cancel</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="signoff-modal" onclick="if(event.target===this)closeSignoffModal()">
  <div class="modal signoff-modal" onclick="event.stopPropagation()" style="max-width:420px">
    <h3 id="signoff-modal-title">Sign off ‚Äì <span id="signoff-modal-role"></span></h3>
    <p style="font-size:14px;color:var(--text2);margin-bottom:14px">Draw your signature below (finger or mouse):</p>
    <canvas id="signoff-canvas" width="380" height="120" style="display:block;width:100%;max-width:380px;height:120px;border:2px solid var(--glass-border);border-radius:var(--radius-sm);background:#fff;cursor:crosshair;touch-action:none"></canvas>
    <p style="font-size:12px;color:var(--text3);margin-top:8px;margin-bottom:14px">Clear and redraw if needed.</p>
    <label style="display:flex;align-items:flex-start;gap:10px;cursor:pointer;margin-bottom:18px;font-size:14px;color:var(--text)">
      <input type="checkbox" id="signoff-confirm-cb" style="margin-top:3px;width:18px;height:18px" onchange="updateSignoffConfirmState()">
      <span>I confirm I have checked all items for my role.</span>
    </label>
    <div class="modal-actions">
      <button class="cli-note-btn" onclick="clearSignature()">Clear</button>
      <button class="btn-primary" id="signoff-confirm-btn" style="padding:10px 20px" onclick="confirmSignoff()" disabled>Confirm</button>
      <button class="cli-note-btn" onclick="closeSignoffModal()">Cancel</button>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CRA CHECKLIST - 46 ITEMS (from Document 3)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CRA_ITEMS = [
  { role:'estimator', text:'Contract and scope match quote. Second count of material quantities.' },
  { role:'estimator', text:'Scope of works conformance verified.' },
  { role:'estimator', text:'40% net profit minimum verified.' },
  { role:'estimator', text:'New client credit application (VG-AF-068) if applicable.' },
  { role:'estimator', text:'NCI List check completed.' },
  { role:'estimator', text:'Credit check and Director approval obtained.' },
  { role:'estimator', text:'Credit limit approval obtained.' },
  { role:'estimator', text:'Finance Manager sign-off received.' },
  { role:'estimator', text:'PPSR registration completed.' },
  { role:'estimator', text:'Construction drawings receipt confirmed.' },
  { role:'estimator', text:'Material quotes vs budget verified.' },
  { role:'estimator', text:'Alternative fans justification if applicable.' },
  { role:'estimator', text:'BMS verification completed.' },
  { role:'estimator', text:'Tender vs construction drawing variance reviewed.' },
  { role:'estimator', text:'Handover documentation to PM/Co-ord completed.' },
  { role:'estimator', text:'Detailed Simpro description completed.' },
  { role:'estimator', text:'Estimator final review sign-off.' },
  { role:'coordinator', text:'Workshop drawings alignment with contract verified.' },
  { role:'coordinator', text:'Unit availability per program confirmed.' },
  { role:'coordinator', text:'Contract = quote value confirmed.' },
  { role:'coordinator', text:'Payment terms verification (>30 days EOM) completed.' },
  { role:'coordinator', text:'Retentions entered in Simpro.' },
  { role:'coordinator', text:'Late payment policy approval obtained.' },
  { role:'coordinator', text:'WSD builder/consultant approval status confirmed.' },
  { role:'coordinator', text:'WSD uploaded to shared drive.' },
  { role:'coordinator', text:'SWMS established.' },
  { role:'coordinator', text:'Correct Simpro payment terms set.' },
  { role:'coordinator', text:'Site visit booked.' },
  { role:'coordinator', text:'Complete job folder (Admin, WSD, Commissioning, Photos, ITP, Material List, Tech Data, Rough In, Supplier Quotes, SWMS).' },
  { role:'coordinator', text:'Schedule & milestone feasibility review completed.' },
  { role:'pm', text:'Contract/scope vs tender alignment verified.' },
  { role:'pm', text:'Estimator review of subcontract issues completed.' },
  { role:'pm', text:'PM experience assessment completed.' },
  { role:'pm', text:'Plant equipment requirements confirmed.' },
  { role:'pm', text:'Builder program & milestone feasibility reviewed.' },
  { role:'pm', text:'Retention terms verification completed.' },
  { role:'pm', text:'Liquidated damages capping (target 50%) verified.' },
  { role:'pm', text:'Director contract acceptance obtained.' },
  { role:'pm', text:'40% profit feasibility confirmed.' },
  { role:'pm', text:'Simpro margin verification completed.' },
  { role:'pm', text:'Supervisor hours discussion completed.' },
  { role:'pm', text:'Plans and budget review with supervisor completed.' },
  { role:'pm', text:'Electrical requirements communicated.' },
  { role:'pm', text:'Tech data folder access confirmed.' },
  { role:'pm', text:'LD cap duplicate check completed.' },
  { role:'director', text:'Final sign-off: All job aspects reviewed before construction starts.' }
];

const ROLES = [
  { id:'all', name:'All', range:'1-46', color:'#1a3a5f' },
  { id:'estimator', name:'Estimator', range:'1-17', color:'#0d6efd' },
  { id:'coordinator', name:'Project Co-ordinator', range:'18-30', color:'#6366f1' },
  { id:'pm', name:'Project Manager', range:'31-45', color:'#8b5cf6' },
  { id:'director', name:'Director', range:'46', color:'#059669' }
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SAMPLE DATA - Toolern Vale
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DEFAULT_JOBS = [
  {
    id: 'toolern-vale',
    name: 'Toolern Vale District Primary School',
    client: 'Arc3 Pty Ltd',
    builder: 'Arc3',
    value: 94700,
    valueFormatted: '$94,700',
    start: '2026-04-30',
    completion: '2026-07-16',
    subcontractNo: 'RC072114',
    trade: 'Mechanical (Supply & Construction)',
    projectLogo: 'images/toolern-vale-logo.png',
    items: new Array(46).fill(false),
    itemNotes: {},
    signoffs: { estimator: null, coordinator: null, pm: null, director: null },
    createdAt: new Date().toISOString()
  }
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let JOBS = [];
let currentJob = null;
const STORAGE_KEY = 'vpm_cra_jobs';

function loadJobs() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) {
      JOBS = JSON.parse(raw);
    } else {
      JOBS = JSON.parse(JSON.stringify(DEFAULT_JOBS));
      saveJobs();
    }
  } catch (e) {
    JOBS = JSON.parse(JSON.stringify(DEFAULT_JOBS));
    saveJobs();
  }
}

function saveJobs() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(JOBS));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VIEWS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateReminderBanner() {
  const jobs = getAttentionJobs();
  const count = jobs.length;
  const banner = document.getElementById('reminder-banner');
  const text = document.getElementById('reminder-text');
  const link = document.getElementById('reminder-link');
  if (count > 0) {
    text.textContent = count + ' CRA' + (count > 1 ? 's' : '') + ' awaiting your sign-off or in progress.';
    link.onclick = e => {
      e.preventDefault();
      if (jobs.length > 0) openJob(jobs[0].id);
      else showView('dashboard');
    };
    banner.classList.add('visible');
  } else {
    banner.classList.remove('visible');
  }
}

function showView(view) {
  document.getElementById('view-dashboard').style.display = 'none';
  document.getElementById('view-all').style.display = 'none';
  document.getElementById('view-detail').style.display = 'none';
  document.getElementById('fab').style.display = 'none';
  document.querySelectorAll('.topbar-nav a').forEach(a => a.classList.remove('active'));

  if (view === 'dashboard') {
    document.getElementById('view-dashboard').style.display = 'block';
    document.getElementById('nav-dashboard').classList.add('active');
    renderAttention();
  } else if (view === 'all') {
    document.getElementById('view-all').style.display = 'block';
    document.getElementById('nav-all').classList.add('active');
    document.getElementById('fab').style.display = 'flex';
    renderAll();
  } else if (view === 'detail') {
    document.getElementById('view-detail').style.display = 'block';
    document.getElementById('fab').style.display = 'flex';
    renderDetail();
  }
  updateReminderBanner();
}

// Attention = jobs where completion < 100 or Director hasn't signed
function getAttentionJobs() {
  return JOBS.filter(j => {
    const done = (j.items || []).filter(Boolean).length;
    const pct = Math.round((done / 46) * 100);
    const directorSigned = j.signoffs && j.signoffs.director;
    return pct < 100 || !directorSigned;
  });
}

function renderAttention() {
  const jobs = getAttentionJobs();
  const count = jobs.length;

  document.getElementById('attention-desc').textContent = count > 0
    ? `${count} CRA${count > 1 ? 's' : ''} need completion or your sign-off.`
    : 'Items awaiting your sign-off or overdue.';
  document.getElementById('attention-count').textContent = `${count} item${count !== 1 ? 's' : ''}`;

  const listEl = document.getElementById('attention-list');
  const emptyEl = document.getElementById('attention-empty');

  if (jobs.length === 0) {
    listEl.innerHTML = '';
    emptyEl.style.display = 'block';
    return;
  }
  emptyEl.style.display = 'none';

  listEl.innerHTML = jobs.map(j => renderJobCard(j)).join('');
}

function renderAll() {
  const listEl = document.getElementById('all-list');
  listEl.innerHTML = JOBS.map(j => renderJobCard(j)).join('');
}

function renderJobCard(j) {
  const done = (j.items || []).filter(Boolean).length;
  const pct = Math.min(100, Math.round((done / 46) * 100));
  const directorSigned = j.signoffs && j.signoffs.director;
  const status = directorSigned ? 'complete' : pct > 80 ? 'review' : 'active';
  const fc = pct === 100 ? 'green' : pct > 50 ? 'blue' : pct > 0 ? 'amber' : 'red';

  return `<div class="job-card" onclick="openJob('${j.id}')">
    <div class="job-card-header">
      <div class="job-card-name">${j.name}</div>
      <span class="job-card-status status-${status}">${directorSigned ? 'COMPLETE' : pct > 80 ? 'READY FOR SIGN-OFF' : 'IN PROGRESS'}</span>
    </div>
    <div class="job-card-meta">
      <span>üìã ${j.client}</span>
      <span>üí∞ ${j.valueFormatted || '$' + j.value?.toLocaleString()}</span>
      <span>üìÖ ${formatDate(j.start)} ‚Äì ${formatDate(j.completion)}</span>
    </div>
    <div class="job-card-progress">
      <div class="progress-bar"><div class="progress-fill ${fc}" style="width:${pct}%"></div></div>
      <div class="progress-text"><span>${done}/46 items</span><span>${pct}%</span></div>
    </div>
  </div>`;
}

function formatDate(s) {
  if (!s) return 'TBC';
  const d = new Date(s + 'T00:00:00');
  return d.toLocaleDateString('en-AU', { day: 'numeric', month: 'short', year: 'numeric' });
}

let pendingHighlightIdx = null;
function openJob(id) {
  currentJob = JOBS.find(j => j.id === id);
  if (!currentJob) return;
  if (!currentJob.items) currentJob.items = new Array(46).fill(false);
  if (!currentJob.signoffs) currentJob.signoffs = { estimator: null, coordinator: null, pm: null, director: null };
  if (!currentJob.itemNotes) currentJob.itemNotes = {};
  const items = currentJob.items || [];
  const firstIncomplete = items.findIndex((v, i) => !v);
  if (firstIncomplete >= 0) {
    activeRole = CRA_ITEMS[firstIncomplete].role;
    pendingHighlightIdx = firstIncomplete;
  } else {
    pendingHighlightIdx = null;
  }
  showView('detail');
  if (pendingHighlightIdx !== null) {
    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        const el = document.querySelector(`.cli[data-idx="${pendingHighlightIdx}"]`);
        if (el) {
          el.classList.add('highlight');
          el.scrollIntoView({ behavior: 'smooth', block: 'center' });
          setTimeout(() => el.classList.remove('highlight'), 2500);
        }
        pendingHighlightIdx = null;
      });
    });
  }
}

let notesModalIdx = null;
function openNotesModal(idx) {
  notesModalIdx = idx;
  const j = currentJob;
  if (!j) return;
  j.itemNotes = j.itemNotes || {};
  document.getElementById('notes-modal-num').textContent = idx + 1;
  document.getElementById('notes-modal-text').value = j.itemNotes[String(idx)] || '';
  document.getElementById('notes-modal').classList.add('visible');
  document.getElementById('notes-modal-text').focus();
}
function closeNotesModal() {
  notesModalIdx = null;
  document.getElementById('notes-modal').classList.remove('visible');
}
function saveNote() {
  if (notesModalIdx === null || !currentJob) return;
  currentJob.itemNotes = currentJob.itemNotes || {};
  currentJob.itemNotes[String(notesModalIdx)] = document.getElementById('notes-modal-text').value.trim();
  saveJobs();
  closeNotesModal();
  renderDetail();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DETAIL VIEW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let activeRole = 'all';

function renderDetail() {
  const j = currentJob;
  const done = (j.items || []).filter(Boolean).length;
  const pct = Math.round((done / 46) * 100);

  const logoUrl = j.projectLogo || (j.id === 'toolern-vale' ? 'images/toolern-vale-logo.png' : null);
  const logoHtml = logoUrl ? `<div class="project-logo-wrap"><img src="${logoUrl}" alt="${j.name}" class="project-logo"></div>` : '';
  document.getElementById('contract-header').innerHTML = `
    ${logoHtml}
    <div style="display:flex;flex-wrap:wrap;align-items:flex-start;justify-content:space-between;gap:16px;margin-bottom:16px">
      <div style="flex:1;min-width:0"><h1>${j.name}</h1><p class="sub">${j.client} ¬∑ ${j.subcontractNo || ''} ¬∑ ${j.trade || 'Mechanical'}</p></div>
    </div>
    <div class="contract-meta">
      <div class="meta-box"><div class="meta-box-label">Contract Value</div><div class="meta-box-value">${j.valueFormatted || '$' + (j.value || 0).toLocaleString()}</div></div>
      <div class="meta-box"><div class="meta-box-label">Start</div><div class="meta-box-value">${formatDate(j.start)}</div></div>
      <div class="meta-box"><div class="meta-box-label">Completion</div><div class="meta-box-value">${formatDate(j.completion)}</div></div>
      <div class="meta-box"><div class="meta-box-label">Progress</div><div class="meta-box-value">${pct}%</div></div>
    </div>
  `;

  document.getElementById('role-tabs').innerHTML = ROLES.map(r => {
    const indices = r.id === 'all' ? CRA_ITEMS.map((_, i) => i) : CRA_ITEMS.map((it, i) => it.role === r.id ? i : -1).filter(i => i >= 0);
    let roleDoneCount = 0;
    indices.forEach(i => { if (j.items[i]) roleDoneCount++; });
    return `<div class="role-tab ${r.id === activeRole ? 'active' : ''}" onclick="setRole('${r.id}')">${r.name}<br><small style="font-size:11px;opacity:.8">${roleDoneCount}/${indices.length}</small></div>`;
  }).join('');

  renderChecklistForRole();
  renderSignoffBlock();
}

function setRole(role) {
  activeRole = role;
  document.querySelectorAll('.role-tab').forEach((t, i) => {
    t.classList.toggle('active', ROLES[i] && ROLES[i].id === role);
  });
  renderChecklistForRole();
}

function renderChecklistForRole() {
  const j = currentJob;
  const isAll = activeRole === 'all';
  const items = CRA_ITEMS.map((it, i) => ({ ...it, index: i })).filter(it => isAll || it.role === activeRole);

  const roleLabel = r => ROLES.find(x => x.id === r)?.name || r;

  document.getElementById('checklist-content').innerHTML = isAll
    ? items.reduce((html, { text, index, role }) => {
        const checked = j.items[index];
        const notes = (j.itemNotes || {})[String(index)] || '';
        const hasNote = !!notes.trim();
        const prevItem = index > 0 ? CRA_ITEMS[index - 1] : null;
        const showRoleHeader = !prevItem || prevItem.role !== role;
        const roleHeader = showRoleHeader ? `<div class="checklist-section-title" style="margin-top:${index > 0 ? '24px' : '0'}">${roleLabel(role)}</div>` : '';
        return html + roleHeader + `<div class="cli ${checked ? 'done' : ''}" onclick="toggleItem(${index})" data-idx="${index}">
          <span class="cli-num">${index + 1}</span>
          <div class="cli-check"></div>
          <div class="cli-text">${text}</div>
          <button class="cli-note-btn ${hasNote ? 'has-note' : ''}" onclick="event.stopPropagation();openNotesModal(${index})" title="${hasNote ? 'Edit note' : 'Add note'}">${hasNote ? 'üìù' : 'Note'}</button>
        </div>`;
      }, '')
    : `
    <div class="checklist-section">
      <div class="checklist-section-title">${ROLES.find(r => r.id === activeRole).name} checks (${ROLES.find(r => r.id === activeRole).range})</div>
      <div class="checklist-items">
        ${items.map(({ text, index }) => {
          const checked = j.items[index];
          const notes = (j.itemNotes || {})[String(index)] || '';
          const hasNote = !!notes.trim();
          return `<div class="cli ${checked ? 'done' : ''}" onclick="toggleItem(${index})" data-idx="${index}">
            <span class="cli-num">${index + 1}</span>
            <div class="cli-check"></div>
            <div class="cli-text">${text}</div>
            <button class="cli-note-btn ${hasNote ? 'has-note' : ''}" onclick="event.stopPropagation();openNotesModal(${index})" title="${hasNote ? 'Edit note' : 'Add note'}">${hasNote ? 'üìù' : 'Note'}</button>
          </div>`;
        }).join('')}
      </div>
    </div>
  `;

  const container = document.getElementById('checklist-content');
  if (isAll) container.innerHTML = `<div class="checklist-section"><div class="checklist-items">${container.innerHTML}</div></div>`;
}

function toggleItem(idx) {
  if (!currentJob) return;
  if (!currentJob.items) currentJob.items = new Array(46).fill(false);
  currentJob.items[idx] = !currentJob.items[idx];
  saveJobs();
  renderDetail();
  updateReminderBanner();
}

function renderSignoffBlock() {
  const j = currentJob;
  const s = j.signoffs || {};

  document.getElementById('signoff-block').innerHTML = `
    <h3>Sign-off block</h3>
    <p style="font-size:13px;color:var(--text2);margin-bottom:16px">All 46 items must be complete before final Director sign-off.</p>
    <div class="signoff-grid">
      ${['estimator','coordinator','pm','director'].map(role => {
        const signed = s[role];
        const roleMeta = ROLES.find(r => r.id === role);
        return `<div class="signoff-item ${signed ? 'done' : ''}">
          <div class="signoff-role">${roleMeta.name}</div>
          <div class="signoff-name">${signed ? signed.name : 'Pending'}</div>
          <div class="signoff-date">${signed ? formatDate(signed.date) : ''}</div>
          ${!signed ? `<button class="btn-primary" style="margin-top:8px;padding:8px 16px;font-size:12px" onclick="openSignoffModal('${role}')">Sign off</button>` : (signed.signature ? `<img src="${signed.signature}" alt="Signature" style="margin-top:8px;max-height:36px;max-width:120px;border:1px solid var(--glass-border);border-radius:6px">` : '')}
        </div>`;
      }).join('')}
    </div>
  `;
}

let signoffModalRole = null;
let signoffCanvasDrawn = false;

function openSignoffModal(role) {
  if (!currentJob) return;
  const done = (currentJob.items || []).filter(Boolean).length;
  if (role === 'director' && done < 46) {
    alert('All 46 items must be complete before Director sign-off.');
    return;
  }
  signoffModalRole = role;
  signoffCanvasDrawn = false;
  document.getElementById('signoff-modal-role').textContent = ROLES.find(r => r.id === role).name;
  document.getElementById('signoff-confirm-cb').checked = false;
  document.getElementById('signoff-confirm-btn').disabled = true;
  const canvas = document.getElementById('signoff-canvas');
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = '#fff';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  document.getElementById('signoff-modal').classList.add('visible');
  initSignatureCanvas();
}

function closeSignoffModal() {
  signoffModalRole = null;
  document.getElementById('signoff-modal').classList.remove('visible');
}

function clearSignature() {
  const canvas = document.getElementById('signoff-canvas');
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = '#fff';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  signoffCanvasDrawn = false;
  updateSignoffConfirmState();
}

function initSignatureCanvas() {
  const canvas = document.getElementById('signoff-canvas');
  const ctx = canvas.getContext('2d');
  let drawing = false;
  let lastX = 0, lastY = 0;

  function getPos(e) {
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    return { x: (clientX - rect.left) * scaleX, y: (clientY - rect.top) * scaleY };
  }

  function draw(x, y) {
    ctx.strokeStyle = '#1a2d4a';
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(x, y);
    ctx.stroke();
    lastX = x; lastY = y;
    signoffCanvasDrawn = true;
    updateSignoffConfirmState();
  }

  function handleDown(e) {
    e.preventDefault();
    drawing = true;
    const pos = getPos(e);
    lastX = pos.x; lastY = pos.y;
  }
  function handleMove(e) {
    e.preventDefault();
    if (!drawing) return;
    const pos = getPos(e);
    draw(pos.x, pos.y);
  }
  function handleUp(e) {
    e.preventDefault();
    drawing = false;
  }

  canvas.onpointerdown = handleDown;
  canvas.onpointermove = handleMove;
  canvas.onpointerup = handleUp;
  canvas.onpointerleave = handleUp;
  canvas.ontouchstart = handleDown;
  canvas.ontouchmove = handleMove;
  canvas.ontouchend = handleUp;
}

function updateSignoffConfirmState() {
  const cb = document.getElementById('signoff-confirm-cb');
  const btn = document.getElementById('signoff-confirm-btn');
  if (cb && btn) btn.disabled = !(cb.checked && signoffCanvasDrawn);
}

function confirmSignoff() {
  if (!currentJob || !signoffModalRole) return;
  const canvas = document.getElementById('signoff-canvas');
  const signatureData = canvas.toDataURL('image/png');
  const roleName = signoffModalRole === 'director' ? 'Mat Sullivan' : signoffModalRole.charAt(0).toUpperCase() + signoffModalRole.slice(1);
  currentJob.signoffs = currentJob.signoffs || {};
  currentJob.signoffs[signoffModalRole] = {
    name: roleName,
    date: new Date().toISOString().slice(0, 10),
    signature: signatureData
  };
  saveJobs();
  closeSignoffModal();
  renderDetail();
  updateReminderBanner();
}

function newCRA() {
  const name = prompt('Project name:');
  if (!name) return;
  const id = 'cra-' + Date.now();
  JOBS.push({
    id, name,
    client: 'TBC', value: 0, valueFormatted: 'TBC',
    start: new Date().toISOString().slice(0, 10), completion: '',
    items: new Array(46).fill(false),
    itemNotes: {},
    signoffs: { estimator: null, coordinator: null, pm: null, director: null },
    createdAt: new Date().toISOString()
  });
  saveJobs();
  currentJob = JOBS.find(j => j.id === id);
  showView('detail');
  updateReminderBanner();
}

// Nav
document.getElementById('nav-dashboard').onclick = e => { e.preventDefault(); showView('dashboard'); };
document.getElementById('nav-all').onclick = e => { e.preventDefault(); showView('all'); };

// Init
loadJobs();
if (window.location.search.includes('clearsignoffs=1')) {
  JOBS.forEach(j => {
    if (j.signoffs) {
      j.signoffs.estimator = null;
      j.signoffs.coordinator = null;
      j.signoffs.pm = null;
    }
  });
  saveJobs();
  window.history.replaceState({}, '', window.location.pathname);
}
showView('dashboard');
updateReminderBanner();
</script>
</body>
</html>
